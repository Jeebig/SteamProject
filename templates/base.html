{% load static i18n %}
<!doctype html>
<html lang="{{ request.LANGUAGE_CODE|default:'en' }}">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block meta_title %}Steam Clone{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}Магазин игр SteamClone – каталог, скидки, библиотека и кошелёк.{% endblock %}">
    <link rel="canonical" href="{{ request.build_absolute_uri }}">
    <link rel="preconnect" href="https://cdn.cloudflare.steamstatic.com" crossorigin>
    <link rel="dns-prefetch" href="//cdn.cloudflare.steamstatic.com">
    {% block meta_social %}
    <meta property="og:site_name" content="SteamClone">
    <meta property="og:type" content="website">
    <meta property="og:title" content="{% block og_title %}Steam Clone{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Магазин игр SteamClone – каталог, скидки, библиотека и кошелёк.{% endblock %}">
    {% if og_image %}<meta property="og:image" content="{{ og_image }}">{% endif %}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block tw_title %}Steam Clone{% endblock %}">
    <meta name="twitter:description" content="{% block tw_description %}Магазин игр SteamClone – каталог, скидки, библиотека и кошелёк.{% endblock %}">
    {% if og_image %}<meta name="twitter:image" content="{{ og_image }}">{% endif %}
    {% endblock %}
    <!-- Tailwind via CDN for rapid prototyping -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* small tweaks to better match steam-like dark gradients */
        .steam-header {
            background: linear-gradient(180deg, rgba(11,42,58,0.98) 0%, rgba(7,32,42,0.95) 100%);
            backdrop-filter: saturate(120%) blur(6px);
        }
        /* visual helper classes used across templates */
        .promo-big-shadow {
            box-shadow: 0 20px 40px rgba(0,0,0,0.55);
        }
        /* skeleton placeholder for lazy images */
        .skeleton { background-size: 200% 200%; }
    </style>
    <link rel="stylesheet" href="{% static 'store/responsive.css' %}">
</head>

<body class="bg-[#071722] text-gray-100 font-sans min-h-screen flex flex-col">
    <header class="steam-header sticky top-0 z-50 text-gray-100 border-b border-[#0a1e24] transition-shadow">
        <div class="container mx-auto flex items-center justify-between px-4 py-3">
            <div class="flex items-center gap-6">
                <button id="mobile-nav-toggle" type="button" aria-expanded="false" aria-controls="mobile-nav-panel" class="lg:hidden inline-flex items-center justify-center w-9 h-9 rounded bg-black/30 border border-white/10 text-white focus:outline-none focus:ring-2 focus:ring-white/40" title="{% trans 'Меню' %}">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                    <span class="sr-only">{% trans 'Навигация' %}</span>
                </button>
                <a href="{% url 'store:home' %}" class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-black font-bold">
                        SC</div>
                    <span class="text-xl font-semibold">SteamClone</span>
                </a>

                <nav class="hidden lg:flex items-center gap-6 text-sm">
                    <div class="relative" id="main-menu-wrap">
                        <a id="main-menu-trigger" href="{% url 'store:home' %}"
                           class="hover:underline flex items-center gap-1 select-none"
                           aria-haspopup="true" aria-expanded="false">
                            {% trans 'МАГАЗИН' %}
                            <svg class="w-3 h-3 opacity-80" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"/></svg>
                        </a>
                        <div id="main-menu-panel" class="absolute left-0 top-full mt-2 w-56 bg-[#1b2838]/95 backdrop-blur-sm border border-[#0a1e24] rounded shadow-xl hidden z-50">
                            <ul class="py-1" role="menu" aria-label="{% trans 'Навигация магазина' %}">
                                <li>
                                    <a class="block px-4 py-2 hover:bg-[#0e3b4a]" href="{% url 'store:home' %}" role="menuitem">{% trans 'Главная' %}</a>
                                </li>
                                <li>
                                    <a class="block px-4 py-2 hover:bg-[#0e3b4a]" href="{% url 'store:charts' %}" role="menuitem">{% trans 'Чарты' %}</a>
                                </li>
                                <li>
                                    <a class="block px-4 py-2 hover:bg-[#0e3b4a]" href="{% url 'store:recommendations' %}" role="menuitem">{% trans 'Рекомендации' %}</a>
                                </li>
                                {# по просьбе: в магазине не показываем "Мои заказы" #}
                                <li>
                                    {% if user.is_authenticated %}
                                    <a class="block px-4 py-2 hover:bg-[#0e3b4a]" href="{% url 'store:wishlist' %}" role="menuitem">{% trans 'Список желаемого' %}</a>
                                    {% else %}
                                    <a class="block px-4 py-2 hover:bg-[#0e3b4a]" href="{% url 'login' %}?next={% url 'store:wishlist' %}" role="menuitem">{% trans 'Список желаемого' %}</a>
                                    {% endif %}
                                </li>
                                {# убрали неиспользуемые пункты меню #}
                                <li class="border-t border-[#0a1e24] mt-1 pt-1">
                                    <a class="block px-4 py-2 hover:bg-[#0e3b4a]" href="{% url 'store:about' %}" role="menuitem">{% trans 'Информация' %}</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    {% if user.is_authenticated %}
                    <a href="{% url 'store:library' %}" class="hover:underline">{% trans 'БИБЛИОТЕКА' %}</a>
                    {% endif %}
                    <a href="{% url 'store:support' %}" class="hover:underline">{% trans 'ПОДДЕРЖКА' %}</a>
                </nav>
            </div>

            <div class="flex items-center gap-3">
                <div class="hidden md:block relative" id="site-search-wrap">
                    <form action="{% url 'store:game_list' %}" method="get">
                        <input name="q" id="site-search-input" placeholder="{% trans 'Поиск по магазину' %}" autocomplete="off"
                            class="rounded-md px-3 py-1 bg-[#0f2b36] placeholder-gray-400 text-sm w-64 focus:outline-none focus:ring-2 focus:ring-white/30" />
                    </form>
                    <div id="site-search-suggest" class="absolute left-0 mt-1 w-[28rem] max-w-[80vw] bg-[#0c2129] border border-[#0a1e24] rounded-md shadow-2xl overflow-hidden hidden z-50">
                        <ul id="site-search-list" class="divide-y divide-[#0a1e24]"></ul>
                    </div>
                </div>
                <span class="md:hidden inline-flex items-center text-xs px-2 py-0.5 rounded bg-black/30 border border-white/10" title="{% trans 'Активный язык' %}">{{ request.LANGUAGE_CODE|upper }}</span>
                {% if user.is_authenticated %}
                                <div class="relative" id="lang-switch-wrap">
                                    <select id="lang-switch" class="text-sm bg-[#0f2b36] rounded px-2 py-1 border border-[#1c4a5b]">
                                        {% get_current_language as CURRENT_LANG %}
                                        {% get_available_languages as LANGS %}
                                        {% for code,name in LANGS %}
                                            <option value="{{ code }}" {% if code == CURRENT_LANG %}selected{% endif %}>{{ code|upper }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                <div class="relative flex items-center gap-2" id="account-menu-wrap">
                    <!-- Username links to profile; balance below; dropdown on arrow; avatar on the right -->
                    <a href="{% url 'store:profile' user.username %}" class="leading-tight group select-none">
                        <div class="text-sm font-medium group-hover:underline">{{ user.username }}</div>
                        <div class="text-[11px] text-blue-200" title="{% trans 'Баланс кошелька' %}">
                            {% with cur=user.profile.preferred_currency bal=user.profile.balance %}
                                {{ bal|floatformat:2 }}{% if cur == 'UAH' %}₴{% else %} {{ cur }}{% endif %}
                            {% endwith %}
                        </div>
                    </a>
                    <button id="account-menu-trigger" type="button" class="p-1 rounded hover:bg-[#0e3b4a]" aria-haspopup="true" aria-expanded="false" title="{% trans 'Меню аккаунта' %}">
                        <svg class="w-4 h-4 opacity-80" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"/></svg>
                    </button>
                    <a href="{% url 'store:profile' user.username %}" class="block" title="{% trans 'Профиль' %}">
                        {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" alt="avatar" class="w-8 h-8 rounded border border-white/20 object-cover" width="32" height="32" loading="lazy">
                        {% elif user.profile.steam_avatar %}
                        <img src="{{ user.profile.steam_avatar }}" alt="avatar" class="w-8 h-8 rounded border border-white/20 object-cover" width="32" height="32" loading="lazy">
                        {% else %}
                        <div class="w-8 h-8 rounded bg-black/30 border border-white/10 flex items-center justify-center text-xs">?</div>
                        {% endif %}
                    </a>
                    <div id="account-menu-panel" class="absolute right-0 top-full mt-2 w-60 bg-[#1b2838]/95 backdrop-blur-sm border border-[#0a1e24] rounded shadow-xl hidden z-50">
                        <ul class="py-1" role="menu" aria-label="Меню аккаунта">
                            <li class="px-4 py-2 text-xs text-gray-400 uppercase tracking-wide">Аккаунт</li>
                            <li>
                                <a href="{% url 'store:wallet_topup' %}" class="flex items-center justify-between px-4 py-2 hover:bg-[#0e3b4a]" role="menuitem">
                                    <span>Баланс</span>
                                    <span class="text-blue-200 font-medium">{% with cur=user.profile.preferred_currency bal=user.profile.balance %}{{ bal|floatformat:2 }}{% if cur == 'UAH' %}₴{% else %} {{ cur }}{% endif %}{% endwith %}</span>
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'store:orders_list' %}" class="block px-4 py-2 hover:bg-[#0e3b4a]" role="menuitem">{% trans 'Мои заказы' %}</a>
                            </li>
                            <li><a href="{% url 'store:wallet_topup' %}" class="block px-4 py-2 hover:bg-[#0e3b4a]" role="menuitem">{% trans 'Кошелёк' %}</a></li>
                            <li><a href="{% url 'store:friends' %}" class="block px-4 py-2 hover:bg-[#0e3b4a]" role="menuitem">{% trans 'Друзья' %}</a></li>
                            <li><a href="{% url 'store:subscriptions' %}" class="block px-4 py-2 hover:bg-[#0e3b4a]" role="menuitem">{% trans 'Подписки' %}</a></li>
                            <li><a href="{% url 'store:notifications' %}" class="block px-4 py-2 hover:bg-[#0e3b4a]" role="menuitem">{% trans 'Уведомления' %}</a></li>
                            <li><a href="{% url 'store:support_tickets' %}" class="block px-4 py-2 hover:bg-[#0e3b4a]" role="menuitem">{% trans 'Мои обращения' %}</a></li>
                            <li class="border-t border-[#0a1e24] mt-1 pt-1"><a href="{% url 'store:profile_edit' %}" class="block px-4 py-2 hover:bg-[#0e3b4a]" role="menuitem">{% trans 'Редактировать профиль' %}</a></li>
                            <li><a href="{% url 'store:settings_default' %}" class="block px-4 py-2 hover:bg-[#0e3b4a]" role="menuitem">{% trans 'Настройки' %}</a></li>
                            <li class="border-t border-[#0a1e24] mt-1 pt-1"><form action="{% url 'store:logout' %}" method="post">{% csrf_token %}<button type="submit" class="w-full text-left px-4 py-2 hover:bg-[#0e3b4a]" role="menuitem">{% trans 'Выйти' %}</button></form></li>
                        </ul>
                    </div>
                </div>
                {% endif %}
                <a href="{% url 'store:cart' %}" class="text-sm px-3 py-1 hover:bg-[#0e3b4a] rounded">{% trans 'Корзина' %}{% if user.is_authenticated %} (<span id="cart-count">{{ user.cart_items.count }}</span>){% endif %}</a>
                {% if not user.is_authenticated %}
                <a href="{% url 'login' %}?next={{ request.path }}" class="text-sm px-3 py-1 bg-[#1b6b80] rounded">{% trans 'Войти' %}
                </a>
                {% endif %}
            </div>
        </div>
    </header>

    <!-- Mobile navigation panel -->
    <div id="mobile-nav-panel" class="lg:hidden fixed inset-x-0 top-[60px] z-40 max-h-[calc(100vh-60px)] overflow-y-auto hidden">
        <nav class="bg-[#0d2730] border-t border-[#0a1e24] shadow-2xl px-4 py-4 space-y-4" aria-label="{% trans 'Мобильное меню' %}">
            <div class="grid grid-cols-2 gap-3 text-sm">
                <a href="{% url 'store:home' %}" class="px-3 py-2 rounded bg-[#12333f] hover:bg-[#18566f] text-white">{% trans 'Главная' %}</a>
                <a href="{% url 'store:game_list' %}" class="px-3 py-2 rounded bg-[#12333f] hover:bg-[#18566f] text-white">{% trans 'Каталог' %}</a>
                <a href="{% url 'store:recommendations' %}" class="px-3 py-2 rounded bg-[#12333f] hover:bg-[#18566f] text-white">{% trans 'Рекомендации' %}</a>
                <a href="{% url 'store:charts' %}" class="px-3 py-2 rounded bg-[#12333f] hover:bg-[#18566f] text-white">{% trans 'Чарты' %}</a>
                <a href="{% url 'store:discounts' %}" class="px-3 py-2 rounded bg-[#12333f] hover:bg-[#18566f] text-white">{% trans 'Скидки' %}</a>
                <a href="{% url 'store:support' %}" class="px-3 py-2 rounded bg-[#12333f] hover:bg-[#18566f] text-white">{% trans 'ПОДДЕРЖКА' %}</a>
                {% if user.is_authenticated %}
                <a href="{% url 'store:wishlist' %}" class="px-3 py-2 rounded bg-[#12333f] hover:bg-[#18566f] text-white">{% trans 'Список желаемого' %}</a>
                <a href="{% url 'store:library' %}" class="px-3 py-2 rounded bg-[#12333f] hover:bg-[#18566f] text-white">{% trans 'БИБЛИОТЕКА' %}</a>
                {% endif %}
            </div>
            <div class="mt-2">
                <form action="{% url 'store:game_list' %}" method="get" class="flex gap-2">
                    <input name="q" placeholder="{% trans 'Поиск' %}" class="flex-1 rounded px-3 py-2 bg-[#0f2b36] text-sm focus:outline-none focus:ring-2 focus:ring-white/30" />
                    <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white text-sm">{% trans 'Поиск' %}</button>
                </form>
            </div>
            {% if user.is_authenticated %}
            <div class="pt-3 border-t border-[#0a1e24] text-sm">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-semibold">{{ user.username }}</span>
                    <span class="text-blue-200" title="{% trans 'Баланс кошелька' %}">{% with cur=user.profile.preferred_currency bal=user.profile.balance %}{{ bal|floatformat:2 }}{% if cur == 'UAH' %}₴{% else %} {{ cur }}{% endif %}{% endwith %}</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <a href="{% url 'store:wallet_topup' %}" class="px-2 py-1 rounded bg-[#1b6b80] text-white text-center">{% trans 'Кошелёк' %}</a>
                    <a href="{% url 'store:notifications' %}" class="px-2 py-1 rounded bg-[#1b6b80] text-white text-center">{% trans 'Уведомления' %}</a>
                    <a href="{% url 'store:settings_default' %}" class="px-2 py-1 rounded bg-[#1b6b80] text-white text-center">{% trans 'Настройки' %}</a>
                    <a href="{% url 'store:friends' %}" class="px-2 py-1 rounded bg-[#1b6b80] text-white text-center">{% trans 'Друзья' %}</a>
                    <form action="{% url 'store:logout' %}" method="post" class="col-span-2">
                        {% csrf_token %}
                        <button type="submit" class="w-full px-2 py-2 rounded bg-red-600 text-white">{% trans 'Выйти' %}</button>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="pt-3 border-t border-[#0a1e24]">
                <a href="{% url 'login' %}" class="block w-full px-3 py-2 rounded bg-[#1b6b80] text-white text-center text-sm">{% trans 'Войти' %}</a>
            </div>
            {% endif %}
        </nav>
    </div>

    <main class="container mx-auto p-4 flex-1">
        {% if messages %}
        <div class="mb-4 space-y-2">
            {% for message in messages %}
                <div class="px-4 py-2 rounded {{ message.tags|default:'info'|yesno:'bg-green-900,bg-yellow-900,bg-red-900' }}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
        {% endif %}
        {% block content %}{% endblock %}
    </main>

    <footer class="mt-10 bg-[#0b2230] border-t border-[#0a1e24] text-gray-300">
        <div class="container mx-auto px-4 py-10 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
            <div>
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-black font-bold">SC</div>
                    <span class="text-lg font-semibold">SteamClone</span>
                </div>
                <p class="text-sm text-blue-100">{% trans 'Небольшой магазин игр в стиле Steam: каталог, скидки, библиотека и кошелёк.' %}</p>
            </div>
            <div>
                <h3 class="text-sm uppercase tracking-wider text-blue-200 mb-3">{% trans 'Разделы' %}</h3>
                <ul class="space-y-2 text-sm">
                    <li><a class="hover:text-white" href="{% url 'store:home' %}">{% trans 'Главная' %}</a></li>
                    <li><a class="hover:text-white" href="{% url 'store:charts' %}">{% trans 'Чарты' %}</a></li>
                    <li><a class="hover:text-white" href="{% url 'store:recommendations' %}">{% trans 'Рекомендации' %}</a></li>
                    <li><a class="hover:text-white" href="{% url 'store:wishlist' %}">{% trans 'Список желаемого' %}</a></li>
                </ul>
            </div>
            <div>
                <h3 class="text-sm uppercase tracking-wider text-blue-200 mb-3">{% trans 'Аккаунт' %}</h3>
                <ul class="space-y-2 text-sm">
                    {% if user.is_authenticated %}
                        <li><a class="hover:text-white" href="{% url 'store:library' %}">{% trans 'БИБЛИОТЕКА' %}</a></li>
                        <li><a class="hover:text-white" href="{% url 'store:settings_default' %}">{% trans 'Настройки' %}</a></li>
                        <li><a class="hover:text-white" href="{% url 'store:support' %}">{% trans 'ПОДДЕРЖКА' %}</a></li>
                    {% else %}
                        <li><a class="hover:text-white" href="{% url 'login' %}">{% trans 'Войти' %}</a></li>
                        <li><a class="hover:text-white" href="{% url 'store:support' %}">{% trans 'ПОДДЕРЖКА' %}</a></li>
                    {% endif %}
                </ul>
            </div>
            <div>
                <h3 class="text-sm uppercase tracking-wider text-blue-200 mb-3">{% trans 'Мы в соцсетях' %}</h3>
                <div class="flex items-center gap-3">
                    <a href="#" class="w-9 h-9 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center" aria-label="Twitter" title="Twitter">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="text-blue-300"><path d="M22.46 6c-.77.35-1.6.58-2.46.69a4.27 4.27 0 0 0 1.88-2.36 8.49 8.49 0 0 1-2.7 1.03 4.24 4.24 0 0 0-7.23 3.87A12.04 12.04 0 0 1 3.15 4.6a4.24 4.24 0 0 0 1.31 5.66 4.2 4.2 0 0 1-1.92-.53v.05a4.24 4.24 0 0 0 3.4 4.16 4.25 4.25 0 0 1-1.91.07 4.24 4.24 0 0 0 3.95 2.94A8.51 8.51 0 0 1 2 19.54 12.01 12.01 0 0 0 8.29 21c7.55 0 11.68-6.26 11.68-11.68 0-.18 0-.36-.01-.53A8.35 8.35 0 0 0 22.46 6z"/></svg>
                    </a>
                    <a href="#" class="w-9 h-9 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center" aria-label="YouTube" title="YouTube">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="text-red-400"><path d="M21.8 8s-.2-1.4-.8-2c-.8-.8-1.6-.8-2-0.9C16.7 4.8 12 4.8 12 4.8h0s-4.7 0-7 .3c-.4 0-1.2.1-2 .9-.6.6-.8 2-.8 2S2 9.6 2 11.2v1.6C2 14.4 2.2 16 2.2 16s.2 1.4.8 2c.8.8 1.8.8 2.2.9 1.6.2 6.8.3 6.8.3s4.7 0 7-.3c.4 0 1.2-.1 2-.9.6-.6.8-2 .8-2s.2-1.6.2-3.2v-1.6C22 9.6 21.8 8 21.8 8zM10 14.7V8.9l5.8 2.9L10 14.7z"/></svg>
                    </a>
                    <a href="#" class="w-9 h-9 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center" aria-label="GitHub" title="GitHub">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="text-gray-200"><path d="M12 .5a12 12 0 0 0-3.8 23.4c.6.1.8-.3.8-.6v-2.2c-3.3.7-4-1.6-4-1.6-.6-1.4-1.3-1.8-1.3-1.8-1-.7.1-.7.1-.7 1 .1 1.6 1 1.6 1 .9 1.6 2.6 1.2 3.2.9.1-.7.4-1.2.7-1.5-2.7-.3-5.5-1.4-5.5-6.1 0-1.3.5-2.5 1.2-3.4-.1-.3-.5-1.6.1-3.3 0 0 1-.3 3.5 1.3a12 12 0 0 1 6.4 0c2.5-1.6 3.5-1.3 3.5-1.3.6 1.7.2 3 .1 3.3.8.9 1.2 2.1 1.2 3.4 0 4.7-2.8 5.8-5.5 6.1.4.4.8 1 .8 2.1v3c0 .3.2.7.8.6A12 12 0 0 0 12 .5z"/></svg>
                    </a>
                </div>
            </div>
        </div>
        <div class="border-t border-[#0a1e24] text-center text-sm text-blue-200 py-4">
            &copy; {% now "Y" %} SteamClone · {% trans 'Все права защищены' %}
        </div>
    </footer>

    <!-- small global scripts for UI (kept minimal) -->
    <script>
                // Header shadow on scroll
                (function(){
                    const h = document.querySelector('header.steam-header');
                    if(!h) return;
                    const onScroll = () => {
                        if (window.scrollY > 2) h.classList.add('shadow-lg'); else h.classList.remove('shadow-lg');
                    };
                    onScroll();
                    window.addEventListener('scroll', onScroll, { passive: true });
                })();
                                // Language switch AJAX
                                (function(){
                                    const sel = document.getElementById('lang-switch');
                                    if(!sel) return;
                                    sel.addEventListener('change', ()=>{
                                        const lang = sel.value;
                                        fetch('{% url 'store:lang_set' %}', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'X-CSRFToken': (document.querySelector('input[name=csrfmiddlewaretoken]')||{}).value || (function(){
                                                    const m = document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:''; })()
                                            },
                                            body: JSON.stringify({lang})
                                        }).then(r=>r.json()).then(d=>{ if(d.ok){ window.location.reload(); } });
                                    });
                                })();
                (function(){
                    // Mobile nav toggle
                    const mbtn = document.getElementById('mobile-nav-toggle');
                    const mpanel = document.getElementById('mobile-nav-panel');
                    if(mbtn && mpanel){
                        const body = document.body;
                        const closeOnEsc = (e)=>{ if(e.key==='Escape'){ body.classList.remove('mobile-nav-open'); mpanel.classList.add('hidden'); mbtn.setAttribute('aria-expanded','false'); mbtn.focus(); }};
                        mbtn.addEventListener('click', ()=>{
                            const open = !body.classList.contains('mobile-nav-open');
                            body.classList.toggle('mobile-nav-open', open);
                            mpanel.classList.toggle('hidden', !open);
                            mbtn.setAttribute('aria-expanded', open ? 'true':'false');
                            if(open){ document.addEventListener('keydown', closeOnEsc); } else { document.removeEventListener('keydown', closeOnEsc); }
                        });
                        document.addEventListener('click', (e)=>{
                            if(!mpanel.contains(e.target) && !mbtn.contains(e.target) && body.classList.contains('mobile-nav-open')){
                                body.classList.remove('mobile-nav-open');
                                mpanel.classList.add('hidden');
                                mbtn.setAttribute('aria-expanded','false');
                            }
                        });
                    }
                    // --- Store main dropdown: keep open on hover and allow click ---
                    const mmWrap = document.getElementById('main-menu-wrap');
                    const mmTrigger = document.getElementById('main-menu-trigger');
                    const mmPanel = document.getElementById('main-menu-panel');
                    if (mmWrap && mmTrigger && mmPanel){
                        let hideT;
                        const openMenu = () => {
                            clearTimeout(hideT);
                            mmPanel.classList.remove('hidden');
                            mmTrigger.setAttribute('aria-expanded','true');
                        };
                        const closeMenu = () => {
                            hideT = setTimeout(() => {
                                mmPanel.classList.add('hidden');
                                mmTrigger.setAttribute('aria-expanded','false');
                            }, 120);
                        };
                        mmTrigger.addEventListener('mouseenter', openMenu);
                        mmTrigger.addEventListener('focus', openMenu);
                        mmWrap.addEventListener('mouseenter', openMenu);
                        mmWrap.addEventListener('mouseleave', closeMenu);
                        mmPanel.addEventListener('mouseenter', openMenu);
                        mmPanel.addEventListener('mouseleave', closeMenu);
                        document.addEventListener('click', (e)=>{
                            if (!mmWrap.contains(e.target)){
                                mmPanel.classList.add('hidden');
                                mmTrigger.setAttribute('aria-expanded','false');
                            }
                        });
                        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ mmPanel.classList.add('hidden'); mmTrigger.setAttribute('aria-expanded','false'); }});
                    }

                    const wrap = document.getElementById('site-search-wrap');
                    const input = document.getElementById('site-search-input');
                    const panel = document.getElementById('site-search-suggest');
                    const list = document.getElementById('site-search-list');
                    if(!wrap || !input || !panel || !list) return;
                    let t = 0;
                    function hide(){ panel.classList.add('hidden'); }
                    function show(){ panel.classList.remove('hidden'); }
                            const FREE_TEXT = "{% trans 'Бесплатно' %}";
                            function render(items){
                        list.innerHTML = '';
                        if(!items || !items.length){ hide(); return; }
                        const frag = document.createDocumentFragment();
                        items.forEach(it => {
                            const li = document.createElement('li');
                            li.className = 'hover:bg-[#11303a]';
                            const a = document.createElement('a');
                            a.href = it.slug ? ('{% url 'store:game_detail' 'SLUG_PLACEHOLDER' %}'.replace('SLUG_PLACEHOLDER', it.slug)) : '#';
                            a.className = 'flex items-center gap-3 p-2 text-sm text-white';
                            const img = document.createElement('img');
                            img.src = it.image || '{% static 'store/img/placeholder.svg' %}';
                            img.alt = it.title || '';
                            img.width = 84; img.height = 47; img.loading = 'lazy';
                            img.className = 'w-[84px] h-[47px] object-cover rounded';
                            const meta = document.createElement('div');
                            meta.className = 'flex-1 min-w-0';
                            const t = document.createElement('div');
                            t.className = 'truncate font-semibold';
                            t.textContent = it.title || '';
                            const p = document.createElement('div');
                            p.className = 'text-xs text-blue-200';
                            p.textContent = (it.price && it.price > 0) ? `${it.price.toFixed(2)} ${it.currency || ''}` : FREE_TEXT;
                            meta.appendChild(t); meta.appendChild(p);
                            a.appendChild(img); a.appendChild(meta);
                            li.appendChild(a); frag.appendChild(li);
                        });
                        list.appendChild(frag); show();
                    }
                    function fetchSuggest(q){
                        const u = new URL('{% url 'store:search_suggest' %}', window.location.origin);
                        u.searchParams.set('q', q);
                        fetch(u.toString(), { credentials: 'same-origin' })
                            .then(r => r.ok ? r.json() : { items: [] })
                            .then(d => render(d.items || []))
                            .catch(() => hide());
                    }
                    input.addEventListener('input', () => {
                        const q = input.value.trim();
                        if(q.length < 2){ hide(); return; }
                        clearTimeout(t); t = setTimeout(() => fetchSuggest(q), 160);
                    });
                    input.addEventListener('focus', () => { if(list.children.length) show(); });
                    document.addEventListener('click', (e) => { if(!wrap.contains(e.target)) hide(); });
                    document.addEventListener('keydown', (e) => { if(e.key === 'Escape') hide(); });
                })();

                // --- Account menu dropdown ---
                (function(){
                    const wrap = document.getElementById('account-menu-wrap');
                    if(!wrap) return;
                    const trigger = document.getElementById('account-menu-trigger');
                    const panel = document.getElementById('account-menu-panel');
                    let hideT;
                    const open = () => { clearTimeout(hideT); panel.classList.remove('hidden'); trigger.setAttribute('aria-expanded','true'); };
                    const close = () => { hideT = setTimeout(()=>{ panel.classList.add('hidden'); trigger.setAttribute('aria-expanded','false'); },120); };
                    trigger.addEventListener('mouseenter', open);
                    trigger.addEventListener('click', (e)=>{ e.preventDefault(); panel.classList.toggle('hidden'); const exp = panel.classList.contains('hidden') ? 'false':'true'; trigger.setAttribute('aria-expanded',exp);});
                    wrap.addEventListener('mouseenter', open);
                    wrap.addEventListener('mouseleave', close);
                    panel.addEventListener('mouseenter', open);
                    panel.addEventListener('mouseleave', close);
                    document.addEventListener('click', (e)=>{ if(!wrap.contains(e.target)){ panel.classList.add('hidden'); trigger.setAttribute('aria-expanded','false'); } });
                    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ panel.classList.add('hidden'); trigger.setAttribute('aria-expanded','false'); trigger.focus(); } });
                })();

                // --- AJAX add to cart / wishlist (no page reload) ---
                (function(){
                    function getCSRF(){
                        const inp = document.querySelector('input[name=csrfmiddlewaretoken]');
                        if (inp) return inp.value;
                        const m = document.cookie.match(/csrftoken=([^;]+)/);
                        return m ? m[1] : '';
                    }
                    function updateCartCount(n){
                        const el = document.getElementById('cart-count');
                        if (el && (typeof n === 'number' || (typeof n === 'string' && n !== ''))){
                            el.textContent = String(n);
                        }
                    }
                    async function postAjax(url, formData){
                        const resp = await fetch(url, {
                            method: 'POST',
                            headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCSRF() },
                            body: formData,
                            credentials: 'same-origin'
                        });
                        // Best-effort JSON parse
                        try{ return await resp.json(); }catch(_){ return { ok:false }; }
                    }
                    // Delegate submit
                    document.addEventListener('submit', async (e)=>{
                        const form = e.target;
                        if (!(form instanceof HTMLFormElement)) return;
                        const isCart = form.classList.contains('js-cart-add');
                        const isWish = form.classList.contains('js-wishlist-toggle');
                        if (!isCart && !isWish) return;
                        e.preventDefault();
                        const btn = form.querySelector('button[type="submit"],button');
                        const origText = btn ? btn.textContent : '';
                        if (btn){ btn.disabled = true; btn.classList.add('opacity-70'); }
                        try{
                            const fd = new FormData(form);
                            const data = await postAjax(form.action, fd);
                            if (!data || data.ok !== true){
                                // fallback to normal submit on failure
                                form.submit();
                                return;
                            }
                            if (typeof data.cart_items !== 'undefined') updateCartCount(data.cart_items);
                            if (isCart && btn){
                                // If free game path resulted in owned, reflect that
                                if (data.owned){
                                    btn.textContent = 'В библиотеке';
                                } else {
                                    btn.textContent = 'В корзине';
                                }
                                btn.disabled = true;
                            }
                            if (isWish && btn){
                                if (data.in_wishlist === true){
                                    btn.textContent = 'В желаемом';
                                    btn.disabled = true;
                                } else if (data.in_wishlist === false){
                                    // On wishlist page, remove the item row if present
                                    const wrap = form.closest('[data-wishlist-item]');
                                    if (wrap) wrap.remove();
                                    // On other pages, just toggle state
                                    if (!wrap){ btn.textContent = 'Добавлено'; btn.disabled = true; }
                                }
                            }
                        } catch(_err){
                            // fallback to normal submit if network error
                            form.submit();
                        } finally {
                            // Keep disabled when succeeded; else restore if we fell back
                            if (btn && !btn.disabled){ btn.classList.remove('opacity-70'); btn.textContent = origText; }
                        }
                    });
                })();
    </script>
    {% block extra_js %}{% endblock %}
</body>

</html>